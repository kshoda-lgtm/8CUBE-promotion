#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
NotebookLMç”¨Markdownç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
PowerPointãƒ•ã‚¡ã‚¤ãƒ«ã‚’Gemini APIã§åˆ†æã—ã¦Markdownå½¢å¼ã§å‡ºåŠ›
"""

import json
import os
from pathlib import Path
from datetime import datetime
from powerpoint_processor_gemini import GeminiPowerPointProcessor


def generate_markdown_from_json(json_data: dict, output_path: str = None) -> str:
    """
    JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰NotebookLMç”¨ã®Markdownã‚’ç”Ÿæˆ

    Args:
        json_data: PowerPointå‡¦ç†çµæœã®JSONãƒ‡ãƒ¼ã‚¿
        output_path: å‡ºåŠ›å…ˆãƒ‘ã‚¹ï¼ˆçœç•¥æ™‚ã¯æ¨™æº–å‡ºåŠ›ï¼‰

    Returns:
        ç”Ÿæˆã•ã‚ŒãŸMarkdownãƒ†ã‚­ã‚¹ãƒˆ
    """
    file_info = json_data.get('file_info', {})
    analysis = json_data.get('gemini_analysis', {})

    # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã‚’æŠ½å‡ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ç”¨ï¼‰
    file_name = file_info.get('file_name', 'Unknown')
    client_name = analysis.get('client_name', '')
    event_type = analysis.get('event_type', '')

    # ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
    if client_name:
        title = f"ã€{client_name}æ§˜ã€‘{event_type or 'ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³æ¡ˆä»¶'}"
    else:
        title = file_name.replace('.pptx', '')

    # Markdownç”Ÿæˆ
    md_lines = []

    # ãƒ˜ãƒƒãƒ€ãƒ¼
    md_lines.append(f"# {title}\n")
    md_lines.append(f"**å…ƒãƒ•ã‚¡ã‚¤ãƒ«**: `{file_name}`  ")
    md_lines.append(f"**å‡¦ç†æ—¥æ™‚**: {file_info.get('processed_at', '')}  ")
    md_lines.append(f"**ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢**: {analysis.get('confidence_score', 0)}%\n")
    md_lines.append("---\n")

    # åŸºæœ¬æƒ…å ±
    md_lines.append("## ğŸ“‹ åŸºæœ¬æƒ…å ±\n")

    if client_name:
        md_lines.append(f"- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå**: {client_name}")

    if analysis.get('event_date'):
        md_lines.append(f"- **å®Ÿæ–½æ™‚æœŸ**: {analysis.get('event_date')}")

    if event_type:
        md_lines.append(f"- **ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥**: {event_type}")

    if analysis.get('venue'):
        md_lines.append(f"- **ä¼šå ´**: {analysis.get('venue')}")

    if analysis.get('target_count'):
        md_lines.append(f"- **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆäººæ•°**: {analysis.get('target_count')}å")

    md_lines.append("")

    # ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹
    if analysis.get('event_description'):
        md_lines.append("## ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹\n")
        md_lines.append(f"{analysis.get('event_description')}\n")

    # ä¾¡æ ¼æƒ…å ±
    has_price_info = any([
        analysis.get('unit_price'),
        analysis.get('total_cost'),
        analysis.get('order_quantity')
    ])

    if has_price_info:
        md_lines.append("## ğŸ’° ä¾¡æ ¼æƒ…å ±\n")

        if analysis.get('unit_price'):
            md_lines.append(f"- **å˜ä¾¡**: Â¥{analysis.get('unit_price'):,}")

        if analysis.get('total_cost'):
            md_lines.append(f"- **ç·è²»ç”¨**: Â¥{analysis.get('total_cost'):,}")

        if analysis.get('order_quantity'):
            md_lines.append(f"- **ç™ºæ³¨æ•°é‡**: {analysis.get('order_quantity'):,}å€‹")

        md_lines.append("")

    # ç´æœŸ
    if analysis.get('deadline'):
        md_lines.append("## â° ç´æœŸ\n")
        md_lines.append(f"- **ç´æœŸ**: {analysis.get('deadline')}\n")

    # å”åŠ›ä¼šç¤¾
    partner_companies = analysis.get('partner_companies', [])
    if partner_companies:
        md_lines.append("## ğŸ¤ å”åŠ›ä¼šç¤¾\n")
        for company in partner_companies:
            if company:
                md_lines.append(f"- {company}")
        md_lines.append("")

    # ãƒãƒ™ãƒ«ãƒ†ã‚£/æ™¯å“
    novelty_items = analysis.get('novelty_items', [])
    if novelty_items:
        md_lines.append("## ğŸ ãƒãƒ™ãƒ«ãƒ†ã‚£/æ™¯å“\n")
        for item in novelty_items:
            if item:
                md_lines.append(f"- {item}")
        md_lines.append("")

    # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    keywords = analysis.get('keywords', [])
    if keywords:
        md_lines.append("## ğŸ·ï¸ ã‚¿ã‚°ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰\n")
        tags = " ".join([f"`#{kw}`" for kw in keywords if kw])
        md_lines.append(f"{tags}\n")

    # ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«
    slide_sample = json_data.get('slide_texts_sample', '')
    if slide_sample:
        md_lines.append("## ğŸ“„ ã‚¹ãƒ©ã‚¤ãƒ‰å†…å®¹ï¼ˆæŠœç²‹ï¼‰\n")
        md_lines.append("```")
        md_lines.append(slide_sample[:1000])  # 1000æ–‡å­—ã¾ã§
        md_lines.append("```\n")

    # ãƒ•ãƒƒã‚¿ãƒ¼
    md_lines.append("---")
    md_lines.append(f"\n*Generated by Gemini API v4.0 - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*")

    # Markdownæ–‡å­—åˆ—ã‚’ç”Ÿæˆ
    markdown_text = "\n".join(md_lines)

    # ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
    if output_path:
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(markdown_text)
        print(f"âœ… Markdownç”Ÿæˆå®Œäº†: {output_path}")

    return markdown_text


def process_powerpoint_to_markdown(pptx_path: str, api_key: str = None):
    """
    PowerPointãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¦Markdownã‚’ç”Ÿæˆ

    Args:
        pptx_path: PowerPointãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        api_key: Gemini APIã‚­ãƒ¼
    """
    print(f"\n{'='*60}")
    print(f"PowerPoint â†’ Markdown å¤‰æ›ï¼ˆNotebookLMç”¨ï¼‰")
    print(f"{'='*60}\n")

    # ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼åˆæœŸåŒ–
    try:
        processor = GeminiPowerPointProcessor(api_key=api_key)
    except Exception as e:
        print(f"ERROR: {e}")
        return

    # PowerPointå‡¦ç†
    pptx_file = Path(pptx_path)
    print(f"ğŸ“„ Processing: {pptx_file.name}")

    result = processor.process_powerpoint(str(pptx_file))

    if 'error' in result:
        print(f"âŒ ERROR: {result['error']}")
        return

    # JSONä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    json_path = pptx_file.with_suffix('.json')
    with open(json_path, 'w', encoding='utf-8') as f:
        json.dump(result, f, ensure_ascii=False, indent=2)
    print(f"âœ… JSONä¿å­˜: {json_path.name}")

    # Markdownç”Ÿæˆ
    md_path = pptx_file.with_suffix('.md')
    markdown_text = generate_markdown_from_json(result, str(md_path))

    # çµæœè¡¨ç¤º
    print(f"\n{'='*60}")
    print(f"å¤‰æ›å®Œäº†")
    print(f"{'='*60}")
    print(f"ğŸ“„ å…ƒãƒ•ã‚¡ã‚¤ãƒ«: {pptx_file.name}")
    print(f"ğŸ“Š JSON: {json_path.name}")
    print(f"ğŸ“ Markdown: {md_path.name}")
    print(f"ğŸ¯ ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢: {result['gemini_analysis'].get('confidence_score', 0)}%")
    print(f"\nğŸ’¡ NotebookLMã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ–¹æ³•:")
    print(f"   1. https://notebooklm.google.com/ ã«ã‚¢ã‚¯ã‚»ã‚¹")
    print(f"   2. æ–°ã—ã„ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’ä½œæˆ")
    print(f"   3. '{md_path.name}' ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
    print(f"{'='*60}\n")


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    import sys

    # APIã‚­ãƒ¼å–å¾—
    api_key = os.environ.get('GEMINI_API_KEY')
    if not api_key:
        print("\nGemini API key not found in environment variable.")
        api_key = input("Enter your Gemini API key: ").strip()
        if not api_key:
            print("ERROR: API key is required")
            return

    # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹å–å¾—
    if len(sys.argv) > 1:
        pptx_path = sys.argv[1]
    else:
        pptx_path = input("\nPowerPointãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹: ").strip()

    if not Path(pptx_path).exists():
        print(f"ERROR: File not found: {pptx_path}")
        return

    # å‡¦ç†å®Ÿè¡Œ
    process_powerpoint_to_markdown(pptx_path, api_key)


if __name__ == "__main__":
    main()
